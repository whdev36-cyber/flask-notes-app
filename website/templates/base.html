<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notes | {% block title %}{% endblock %}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <style>
        /* Add smooth transitions for modal */
        dialog[open] {
            animation: fadeIn 0.3s ease normal;
        }
        
        dialog[open].closing {
            animation: fadeOut 0.3s ease normal;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        /* Better modal positioning */
        dialog article {
            max-width: 800px;
            width: 90vw;
        }
    </style>
</head>

<body>
    {% include 'nav.html' %}
    <main class="container">
        <!-- Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for ctx, msg in messages %}
                    <dialog id="flash-message">
                        <article>
                            <h2>Notification!</h2>
                            <p>
                                {{ msg }}
                            </p>
                            <footer>
                                <button onclick="document.getElementById('flash-message').close()" aria-label="Close">Ok</button>
                            </footer>
                        </article>
                    </dialog>
                    <script>
                        // Auto-show flash messages
                        document.addEventListener('DOMContentLoaded', () => {
                            const flashDialog = document.getElementById('flash-message');
                            if (flashDialog) flashDialog.showModal();
                        });
                    </script>
                    {% endfor %}
            {% endif %}
        {% endwith %}

        {% block content %}
        {% endblock %}
    </main>
    <script>
        // Enhanced modal handling
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize modal triggers
            document.querySelectorAll('[data-target]').forEach(trigger => {
                trigger.addEventListener('click', toggleModal);
            });
            
            // Close buttons in modals
            document.querySelectorAll('dialog button[aria-label="Close"], dialog footer button').forEach(btn => {
                if (!btn.hasAttribute('data-keep-open')) {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const dialog = btn.closest('dialog');
                        if (dialog) dialog.close();
                    });
                }
            });
        });

        // Toggle modal with better handling
        function toggleModal(event) {
            event.preventDefault();
            const targetId = this.getAttribute('data-target');
            if (!targetId) return;
            
            const modal = document.getElementById(targetId);
            if (!modal) return;
            
            if (modal.open) {
                modal.classList.add('closing');
                setTimeout(() => {
                    modal.close();
                    modal.classList.remove('closing');
                }, 300);
            } else {
                modal.showModal();
            }
        }

        // Close modal when clicking outside
        document.addEventListener('click', (event) => {
            const openDialogs = document.querySelectorAll('dialog[open]');
            openDialogs.forEach(dialog => {
                const isClickInside = dialog.firstElementChild.contains(event.target);
                if (!isClickInside && !event.target.hasAttribute('data-keep-open')) {
                    dialog.classList.add('closing');
                    setTimeout(() => {
                        dialog.close();
                        dialog.classList.remove('closing');
                    }, 300);
                }
            });
        });

        // Close with Esc key
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                const openDialogs = document.querySelectorAll('dialog[open]');
                if (openDialogs.length > 0) {
                    event.preventDefault();
                    const topDialog = openDialogs[openDialogs.length - 1];
                    if (!topDialog.hasAttribute('data-no-escape')) {
                        topDialog.classList.add('closing');
                        setTimeout(() => {
                            topDialog.close();
                            topDialog.classList.remove('closing');
                        }, 300);
                    }
                }
            }
        });
    </script>
</body>

</html>